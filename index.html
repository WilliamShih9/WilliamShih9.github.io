<!DOCTYPE html>
<head>
<script src="https://d3js.org/d3.v7.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3-annotation/2.5.1/d3-annotation.min.js"></script>
<style>

h1 {
    font-family: 'Verdana', sans-serif;
    font-size: 30px;
    font-weight: lighter;
    letter-spacing: 1px;
    line-height: 1;
    text-align: center;
    background-color: #ccffcc;
    padding: 10px;
}

.line {
  fill: none;
  stroke: steelblue;
  stroke-width: 2px;
}

.grid line {
  stroke: lightgrey;
  stroke-opacity: 0.5;
  shape-rendering: crispEdges;
}

.grid path {
  stroke-width: 0;
}

div.tooltip {	
    position: absolute;			
    text-align: center;			
    padding: 2px;				
    font: 13px sans-serif;		
    background: lightsteelblue;	
    border: 0px;		
    border-radius: 8px;			
    pointer-events: none;			
}

div.tooltip2 {	
    position: absolute;			
    text-align: center;			
    padding: 2px;				
    font: 13px sans-serif;		
    background: #ff6666;	
    border: 0px;		
    border-radius: 8px;			
    pointer-events: none;			
}

div.tooltip_reg {	
    position: absolute;			
    text-align: center;			
    padding: 2px;				
    font: 13px sans-serif;		
    background: #3399ff;	
    border: 0px;		
    border-radius: 8px;			
    pointer-events: none;			
}

.bgroup button {
  background-color: #04AA6D; 
  border: 1px solid green; 
  font: 16px sans-serif;		
  color: black; 
  padding: 10px 14px; 
  cursor: pointer; 
}

select{
    padding: 3px 1px; /* Some padding */
}

</style>
</head>
<body onload="init()">
<h1>GDP per capita vs Population Growth of Metro Areas in the OECD</h1>


<div class="bgroup">
    <button id="scene0">Intro</button>
    <button id="scene1">Slide 1</button>
    <button id="scene2">Slide 2</button>
    <button id="scene3">Slide 3</button>
    <button id="scene4">Slide 4</button>
    <button id="scene5">Slide 5</button>
    <button id="scene6">Slide 6</button>
</div>

<hr style="height:2px;border-width:0;color:gray;background-color:gray">

<p id="maintext"></p>

<div>
<hr id = "hiddenhr" style="height:2px;border-width:0;color:gray;background-color:gray" hidden="hidden">
<select id="selectButton" hidden="hidden">></select>
<select id="yaxisButton" hidden="hidden">></select>
</div>


<hr style="height:2px;border-width:0;color:gray;background-color:gray">

<svg>

</svg>

<hr style="height:2px;border-width:0;color:gray;background-color:gray">

<p id="bottomtext">This is the bottom text</p>

<script>

function get_labels(country, yaxis = "PopulationGrowth"){
    if (yaxis == "PopulationGrowth"){
        switch(country){
            case 'France':
                x = "GDP per capita (2015 dollars)(2006)";
                y = "Population in 2018 (2006=100)";
                title = "GDP per capita in 2006 and Population Growth (2006−2018) by Metro Area for France";
                return [x, y, title];
            case 'Japan':
                x = "GDP per capita (2015 dollars)(2001)";
                y = "Population in 2018 (2001=100)";
                title = "GDP per capita in 2001 and Population Growth (2001−2018) by Metro Area for Japan";
                return [x, y, title];
            case 'Italy':
                x = "GDP per capita (2015 dollars)(2002)";
                y = "Population in 2018 (2002 = 100)";
                title = "GDP per capita in 2002 and Population Growth (2002−2018) by Metro Area for Italy";
                return [x, y, title];
            case 'Spain':
                x = "GDP per capita (2015 dollars)(2003)";
                y = "Population in 2018 (2003 = 100)";
                title = "GDP per capita in 2003 and Population Growth (2003−2018) by Metro Area for Spain";
                return [x, y, title];
            default:
                x = "GDP per capita (2015 dollars)(2001)";
                y = "Population in 2019 (2001=100)";
                title  = "GDP per capita in 2001 and Population Growth (2001−2019) by Metro Area for "+country;
                return [x, y, title];
        }
    }
    else if (yaxis == "GDPGrowth"){
        switch(country){
            case 'France':
                x = "GDP per capita (2015 dollars)(2006)";
                y = "GDP per capita in 2018 (2006 = 100)";
                title = "GDP per capita in 2006 and GDP per capita Growth (2006−2018) by Metro Area for France";
                return [x, y, title];
            case 'Japan':
                x = "GDP per capita (2015 dollars)(2001)";
                y = "GDP per capita in 2016 (2001 = 100)";
                title = "GDP per capita in 2001 and GDP per capita Growth (2001−2016) by Metro Area for Japan";
                return [x, y, title];
            case 'Italy':
                x = "GDP per capita (2015 dollars)(2002)";
                y = "GDP per capita in 2018 (2002 = 100)";
                title = "GDP per capita in 2002 and GDP per capita Growth (2002−2018) by Metro Area for Italy";
                return [x, y, title];
            case 'Spain':
                x = "GDP per capita (2015 dollars)(2003)";
                y = "GDP per capita in 2018 (2003 = 100)";
                title = "GDP per capita in 2003 and GDP per capita Growth (2003−2018) by Metro Area for Spain";
                return [x, y, title];
            case 'Canada':
            case 'Germany':
            case 'Poland':
                x = "GDP per capita (2015 dollars)(2001)";
                y = "GDP per capita in 2018 (2001 = 100)";
                title = "GDP per capita in 2001 and GDP per capita Growth (2001-2018) by Metro Area for"+country;
                return [x, y, title];
            default:
                x = "GDP per capita (2015 dollars)(2001)";
                y = "GDP per capita in 2019 (2001 = 100)";
                title = "GDP per capita in 2001 and GDP per capita Growth (2001-2019) by Metro Area for "+country;
                return [x, y, title];
        }
    }
}

function get_GDPyr(country){
    switch(country){
        case 'France':
            return "2006";
        case 'Spain':
            return "2003";
        case 'Italy':
            return "2002";
        default:
            return "2001";
    }
}

function get_GDPendyr(country){
    switch(country){
        case 'Japan':
            return "2016";
        case 'France':
        case 'Italy':
        case 'Spain':
            return "2018";
        default:
            return "2019";
    }
}


function set_all(unselected){
    d3.select("#scene0").style('background-color', unselected);
    d3.select("#scene1").style('background-color', unselected);
    d3.select("#scene2").style('background-color', unselected);
    d3.select("#scene3").style('background-color', unselected);
    d3.select("#scene4").style('background-color', unselected);
    d3.select("#scene5").style('background-color', unselected);
    d3.select("#scene6").style('background-color', unselected);
}

function country_population(population, yaxis){
    if (yaxis == "PopulationGrowth"){
        return "<br/> Population in 2010: "+ d3.format(',')(population);
    }
    else{
        return "";
    }
}


function get_text(num_scene){
    switch (num_scene){
        case 0:
            return "This is Scene 0";
        case 1:
            return "This is Scene 1";
        case 2:
            return "This is Scene 2";
        case 3:
            return "This is Scene 3";
        case 4:
            return "This is Scene 4";
        case 5:
            return "This is Scene 5";
        case 6:
            return "This is Scene 6";
        default:
            return "This is Scene Undefined";
    }
}

function get_annotations(country, yaxis){
    if (yaxis == "PopulationGrowth"){
        switch(country){
            case 'Japan':
                return [
                  {
                    note: {
                      label: "Tokyo is the richest city in Japan and had the fastest population growth"
                    },
                    type: d3.annotationCalloutCircle,
                    subject: {
                      radius: 60,        
                    },
                    color: ["green"],
                    x: 683,
                    y: 160,
                    dy: -20,
                    dx: -60
                  },
                  {
                    note: {
                      label: "Nagoya is relatively rich and relatively fast population growth"
                    },
                    type: d3.annotationCalloutCircle,
                    subject: {
                      radius: 40,        
                    },
                    color: ["green"],
                    x: 543,
                    y: 230,
                    dy: 70,
                    dx: 60
                  }
                ];
            default:
                return [];
        }
    }
    else if (yaxis = "GDPGrowth"){
        switch(country){
            default:
                return [];
        }
    }
}

async function init(){
    var margin = 50;
    var width = 650;
    var height = 550;
    var tooltip = d3.select("body").append("div")
        .attr("class", "tooltip")
        .style("opacity", 0);
    
    var tooltip2 = d3.select("body").append("div")
        .attr("class", "tooltip2")
        .style("opacity", 0);
        
    var tooltip_reg = d3.select("body").append("div")
        .attr("class", "tooltip_reg")
        .style("opacity", 0);
        
    var unselected = "#04AA6D";
    var selected = "#99ccee";
    var cur_scene = 0;
    
    // Country Select Button
    countries = ['Australia','Canada','France','Germany','Italy','Japan','Poland',
                'Spain','United Kingdom','United States'];
    d3.select("#selectButton")
        .selectAll('myOptions')
        .data(countries)
        .enter()
        .append('option')
        .text(function (d) { return d; }) // text showed in the menu
        .attr("value", function (d) { return d; });
    // Y Axis GDP per capita Button or Population growth button
    yaxis = ['Population Growth on Y-Axis','GDP Growth on Y-Axis']
    d3.select("#yaxisButton")
        .selectAll('myOptions')
        .data(yaxis)
        .enter()
        .append('option')
        .text(function (d) { return d; }) // text showed in the menu
        .attr("value", function (d) { return d; });
    
    // Data
    var data = await d3.csv("https://raw.githubusercontent.com/WilliamShih9/WilliamShih9.github.io/main/data_GDP.csv", d3.autoType);
    var aggregate = await d3.csv("https://raw.githubusercontent.com/WilliamShih9/WilliamShih9.github.io/main/aggregates_GDP.csv", d3.autoType);
    
    async function draw_chart(data, aggregate, country = "Japan", yaxis = "PopulationGrowth"){
        d3.select("svg").selectAll('*').remove();
        let lines;
        if (yaxis == "PopulationGrowth"){
            lines = await d3.csv("https://raw.githubusercontent.com/WilliamShih9/WilliamShih9.github.io/main/regression_lines.csv", d3.autoType);
        }
        else if (yaxis == "GDPGrowth"){
            lines = await d3.csv("https://raw.githubusercontent.com/WilliamShih9/WilliamShih9.github.io/main/regression_lines_GDP.csv", d3.autoType);
        }
        
        // Set Text
        d3.select("#maintext").text(get_text(cur_scene));
        
        if (cur_scene == 0){
            return;
        }
        // Agg Data is for the Vertical/Horizontal Line
        agg_data = aggregate.filter(function(row) {
            return row['Country'] == country;
        });
        
        // Line Data is for the Regression Line
        line_data = lines.filter(function(row) {
            return row['Country'] == country;
        });
        filt_data = data.filter(function(row) {
            return row['Country'] == country;
        });
        
        var x_min = d3.min(filt_data, function(d) { return d.GDP; });
        var x_max = d3.max(filt_data, function(d) { return d.GDP; });
        var y_min = d3.min(filt_data, function(d) { return d[yaxis]; }) - 5;
        var y_max = d3.max(filt_data, function(d) { return d[yaxis]; }) + 5;
        
        
        var x = d3.scaleLinear().domain([x_min, x_max]).range([0, width]).nice();
        var y = d3.scaleLinear().domain([y_min, y_max]).range([height, 0]).nice();
        var sqrtScale = d3.scaleSqrt().domain([0, 100]).range([0, 70]);
        
        d3.select("svg")
            .attr("width", width + 2*margin)
            .attr("height", height + 2*margin);
    
        // X Gridlines
        d3.select("svg").append("g")
            .attr("class", "grid")
            .attr("transform","translate("+margin+","+(height+margin)+")")
            .call(d3.axisBottom(x).tickSize(-height).tickFormat('').ticks(10));
          
        // Y Gridlines
        d3.select("svg").append("g")
            .attr("class", "grid")
            .attr("transform","translate("+margin+","+margin+")")
            .call(d3.axisLeft(y).tickSize(-width).tickFormat('').ticks(10));
            
        // X Axis
        d3.select("svg").append("g")
            .style("font-size","11px")
            .attr("transform","translate("+margin+","+(height+margin)+")")
            .call(d3.axisBottom(x).ticks(10));
        
        // Y Axis
        d3.select("svg").append("g")
            .style("font-size","12px")
            .attr("transform","translate("+margin+","+margin+")")
            .call(d3.axisLeft(y).ticks(10));
         
        // Get Labels for X-Axis, Y-Axis, Title for Country
        result = get_labels(country, yaxis);
        x_axis_label = result[0];
        y_axis_label = result[1];
        title = result[2];
        // Text Label X Axis
        d3.select("svg").append("text")             
          .attr("transform",
                "translate(" + ((width+margin)/2) + " ," + 
                               (height + 2*margin - 10) + ")")
          .style("font-size","17px")
          .style("text-anchor", "middle")
          .text(x_axis_label);   
         
        // text label for the y axis
        d3.select("svg").append("text")
          .attr("transform", "rotate(-90)")
          .attr("y", 0)
          .attr("x" ,0 - ((height + margin) / 2))
          .attr("dy", "1em")
          .style("font-size","17px")
          .style("text-anchor", "middle")
          .text(y_axis_label);  
        
        // Title
        d3.select("svg").append("text")
            .attr("transform", "translate("+margin+","+margin+")")
            .attr("x", (width / 2))             
            .attr("y", 0 - (margin / 2))
            .attr("text-anchor", "middle")  
            .style("font-size", "17px") 
            .style("text-decoration", "underline")  
            .text(title);
    
        h_line = agg_data[0][yaxis];
        
        // Add Annotations
        const annotations = get_annotations(country, yaxis);
        if (annotations.length > 0){
            const makeAnnotations = d3.annotation()
              .annotations(annotations);
            d3.select("svg")
                .append("g")
                .call(makeAnnotations);
        }
        // Horizontal Line
        d3.select("svg").append("g")
           .attr("class","hline")
           .attr("transform", "translate("+margin+", "+(margin+y(h_line))+")")
           .append("line")
           .attr("x2", width)
           .style("stroke", "#cc3e2e")
           .style("stroke-width", "4px")
        
        v_line = agg_data[0]["GDP"];
        mult_v = agg_data[0]["GDPGrowth"];
        // Vertical Line
        d3.select("svg").append("g")
           .attr("class", "vline")
           .attr("transform", "translate("+(margin+x(v_line))+","+margin+")")
           .append("line")
           .attr("y2", height)
           .style("stroke", "#cc3e2e")
           .style("stroke-width", "4px")
           
        slope = line_data[0]["Slope"]
        intercept = line_data[0]["Intercept"]
        y_reg_low = x_min * slope + intercept;
        y_reg_high = x_max * slope + intercept;
        // Regression Line
        d3.select("svg").append("g")
            .attr("class","regline")
            .attr("transform","translate("+margin+","+margin+")")
            .append("line")
            .attr("x1", x(x_min))
            .attr("x2", x(x_max))
            .attr("y1", y(y_reg_low))
            .attr("y2", y(y_reg_high))
            .style("stroke", "#2e31cc")
            .style("stroke-width", "4px")
        
        // Data
        d3.select("svg").append("g")
            .attr("transform", "translate(" +margin+ "," +margin+ ")")
            .selectAll("dot")
            .data(filt_data)
            .enter().append("circle")
            .attr("cx", function (d) { return x(d.GDP); })
            .attr("cy", function (d) { return y(d[yaxis]); })
            .attr("r",  function (d) { return sqrtScale(d.Percent); })
        
        
        // Tooltip for Circles
        d3.select("svg").selectAll("circle").data(filt_data)
            .on("mouseover", function(event, d) {		
                tooltip.transition()		
                    .duration(200)		
                    .style("opacity", .9);		
                tooltip.html(d.Metro + "<br/>"  + "Pop(2010):"+d3.format(',')(d.Population)
                            + "<br/>GDP(" + get_GDPyr(country) + "):" + d3.format(',')(d.GDP)
                            + "<br/>GDP(" + get_GDPendyr(country) + "):" + d3.format(',')(d.GDPGrowth/100*d.GDP))
                    .style("left", (event.pageX) + "px")		
                    .style("top", (event.pageY - 28) + "px");	
            })	
            .on("mousemove", function(event){
                tooltip
                    .style("left", (event.pageX) + "px")
                    .style("top", (event.pageY- 28) + "px");
            })
            .on("mouseout", function(event) {		
                tooltip.transition()		
                    .duration(500)		
                    .style("opacity", 0);	
            });
        
        // Tooltip for Horizontal  Line
        d3.select("svg").select(".hline")
            .on("mouseover", function(event, d) {		
                tooltip2.transition()		
                    .duration(200)		
                    .style("opacity", .9);		
                tooltip2.html(country+"<br/>"+ y_axis_label + ": " + d3.format(".2f")(h_line) 
                            + country_population(agg_data[0]["Population"], yaxis))
                    .style("left", (event.pageX) + "px")		
                    .style("top", (event.pageY + 18) + "px");	
            })	
            .on("mousemove", function(event){
                tooltip2
                    .style("left", (event.pageX) + "px")
                    .style("top", (event.pageY + 18) + "px");
            })
            .on("mouseout", function(event) {		
                tooltip2.transition()		
                    .duration(500)		
                    .style("opacity", 0);	
            });
        // Tooltip for Vertical Line
        d3.select("svg").select(".vline")
            .on("mouseover", function(event, d) {		
                tooltip2.transition()		
                    .duration(200)		
                    .style("opacity", .9);		
                tooltip2.html(country+"<br/>"+ x_axis_label + ": " + d3.format(',')(v_line)
                            + "<br/>GDP per capita (" + get_GDPendyr(country) + "): " 
                            + d3.format(',')(v_line*mult_v/100))
                    .style("left", (event.pageX) + "px")		
                    .style("top", (event.pageY + 18) + "px");	
            })	
            .on("mousemove", function(event){
                tooltip2
                    .style("left", (event.pageX) + "px")
                    .style("top", (event.pageY + 18) + "px");
            })
            .on("mouseout", function(event) {		
                tooltip2.transition()		
                    .duration(500)		
                    .style("opacity", 0);	
            });
        // Tooltip for Regression Line
        d3.select("svg").select(".regline")
            .on("mouseover", function(event, d) {		
                tooltip_reg.transition()		
                    .duration(200)		
                    .style("opacity", .9);		
                tooltip_reg.html("Regression Line <br/>R^2 of line: "+
                    d3.format('.3f')(line_data[0]["R2"]) + "<br/>p = " +
                    d3.format('.3')(line_data[0]["Pval"]))
                    .style("left", (event.pageX) + "px")		
                    .style("top", (event.pageY + 18) + "px");	
            })	
            .on("mousemove", function(event){
                tooltip_reg
                    .style("left", (event.pageX) + "px")
                    .style("top", (event.pageY + 18) + "px");
            })
            .on("mouseout", function(event) {		
                tooltip_reg.transition()		
                    .duration(100)		
                    .style("opacity", 0);	
            });
    }
    draw_chart(data, aggregate, "Japan", "PopulationGrowth");
    d3.select("#scene0").style('background-color', selected);
    
    d3.select("#scene0").on("click", function() {  
        cur_scene = 0;
        set_all(unselected);
        d3.select(this).style('background-color', selected);
        document.getElementById("hiddenhr").setAttribute("hidden","hidden"); 
        document.getElementById("selectButton").setAttribute("hidden","hidden");
        document.getElementById("yaxisButton").setAttribute("hidden","hidden"); 
        draw_chart(data, aggregate, "Japan", "PopulationGrowth");
    });
    
    d3.select("#scene1").on("click", function() {  
        cur_scene = 1;
        set_all(unselected);
        d3.select(this).style('background-color', selected);
        d3.select("#selectButton").property('value', "Japan");
        d3.select("#yaxisButton").property('value','Population Growth on Y-Axis');
        draw_chart(data, aggregate, "Japan", "PopulationGrowth");
    });
    d3.select("#scene2").on("click", function() {  
        cur_scene = 2;
        set_all(unselected);
        d3.select(this).style('background-color', selected);
        d3.select("#selectButton").property('value', "Japan");
        d3.select("#yaxisButton").property('value','GDP Growth on Y-Axis');
        draw_chart(data, aggregate, "Japan", "GDPGrowth");
    });
    d3.select("#scene3").on("click", function() {  
        cur_scene = 3;
        set_all(unselected);
        d3.select(this).style('background-color', selected);
        d3.select("#selectButton").property('value', "United States");
        d3.select("#yaxisButton").property('value','Population Growth on Y-Axis');
        draw_chart(data, aggregate, "United States", "PopulationGrowth");
    });
    d3.select("#scene4").on("click", function() {  
        cur_scene = 4;
        set_all(unselected);
        d3.select(this).style('background-color', selected);
        d3.select("#selectButton").property('value', "United States");
        d3.select("#yaxisButton").property('value','GDP Growth on Y-Axis');
        draw_chart(data, aggregate, "United States", "GDPGrowth");
    });
    d3.select("#scene5").on("click", function() {  
        cur_scene = 5;
        set_all(unselected);
        d3.select(this).style('background-color', selected);
        d3.select("#selectButton").property('value', "France");
        d3.select("#yaxisButton").property('value','Population Growth on Y-Axis');
        draw_chart(data, aggregate, "France", "PopulationGrowth");
    });
    d3.select("#scene6").on("click", function() {  
        cur_scene = 6;
        set_all(unselected);
        d3.select(this).style('background-color', selected);
        d3.select("#selectButton").property('value', "France");
        d3.select("#yaxisButton").property('value','GDP Growth on Y-Axis');
        draw_chart(data, aggregate, "France", "GDPGrowth");
        // Unhide Buttons
        document.getElementById("hiddenhr").removeAttribute("hidden"); 
        document.getElementById("selectButton").removeAttribute("hidden");
        document.getElementById("yaxisButton").removeAttribute("hidden"); 
        
        d3.select("#selectButton")
            .on("change", function (event){
                yaxis_val = d3.select("#yaxisButton").node().value;
                country_val = d3.select("#selectButton").node().value;
                if (yaxis_val == "GDP Growth on Y-Axis"){
                    draw_chart(data, aggregate, country_val, "GDPGrowth");
                }
                else if (yaxis_val == "Population Growth on Y-Axis"){
                    draw_chart(data, aggregate, country_val, "PopulationGrowth");
                }
            });
        d3.select("#yaxisButton")
            .on("change", function (event){
                yaxis_val = d3.select("#yaxisButton").node().value;
                country_val = d3.select("#selectButton").node().value;
                if (yaxis_val == "GDP Growth on Y-Axis"){
                    draw_chart(data, aggregate, country_val, "GDPGrowth");
                }
                else if (yaxis_val == "Population Growth on Y-Axis"){
                    draw_chart(data, aggregate, country_val, "PopulationGrowth");
                }
            });
    });
    
}

</script>
</body>
</html>

<!DOCTYPE html>
<meta charset="utf-8">

