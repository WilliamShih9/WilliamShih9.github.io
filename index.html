<!DOCTYPE html>
<head>
<script src="https://d3js.org/d3.v7.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3-annotation/2.5.1/d3-annotation.min.js"></script>
<style>

h1 {
    font-family: 'Verdana', sans-serif;
    font-size: 30px;
    font-weight: lighter;
    letter-spacing: 1px;
    line-height: 1;
    text-align: center;
    background-color: #ccffcc;
    padding: 10px;
}

.line {
  fill: none;
  stroke: steelblue;
  stroke-width: 2px;
}

.grid line {
  stroke: lightgrey;
  stroke-opacity: 0.5;
  shape-rendering: crispEdges;
}

.grid path {
  stroke-width: 0;
}

div.tooltip {	
    position: absolute;			
    text-align: center;			
    padding: 2px;				
    font: 13px sans-serif;		
    background: lightsteelblue;	
    border: 0px;		
    border-radius: 8px;			
    pointer-events: none;			
}

div.tooltip2 {	
    position: absolute;			
    text-align: center;			
    padding: 2px;				
    font: 13px sans-serif;		
    background: #ff6666;	
    border: 0px;		
    border-radius: 8px;			
    pointer-events: none;			
}

div.tooltip_reg {	
    position: absolute;			
    text-align: center;			
    padding: 2px;				
    font: 13px sans-serif;		
    background: #3399ff;	
    border: 0px;		
    border-radius: 8px;			
    pointer-events: none;			
}

.bgroup button {
  background-color: #04AA6D; 
  border: 1px solid green; 
  font: 16px sans-serif;		
  color: black; 
  padding: 10px 14px; 
  cursor: pointer; 
}

select{
	font-size: 18px;
    padding: 3px 1px; /* Some padding */
}

p {
   word-wrap: break-word;
   text-align: left;		
   width:90%;
   max-width: 1000px;
   margin:0 auto;
   line-height: 1.6;
}

</style>
</head>
<body onload="init()">
<h1>GDP per capita vs Population Growth of Metro Areas of Major Developed Countries</h1>


<div class="bgroup">
    <button id="scene0">Intro</button>
    <button id="scene1">Slide 1</button>
    <button id="scene2">Slide 2</button>
    <button id="scene3">Slide 3</button>
    <button id="scene4">Slide 4</button>
    <button id="scene5">Slide 5</button>
    <button id="scene6">Slide 6</button>
</div>

<hr style="height:2px;border-width:0;color:gray;background-color:gray">

<p id="maintext"></p>

<div style="text-align:center;">
<hr id = "hiddenhr" style="height:2px;border-width:0;color:gray;background-color:gray" hidden="hidden">
<select id="selectButton" hidden="hidden" disabled="true"></select>
<select id="yaxisButton" hidden="hidden" disabled="true"></select>
</div>


<hr style="height:2px;border-width:0;color:gray;background-color:gray">

<div style="text-align:center;">
<svg>

</svg>
</div>



<p id="bottomtext" hidden = "hidden"><br/><br/>Notes: 1. GDP per capita is adjusted for purchasing 
    power parity (PPP).<br/> 2. The population used to obtain the size of the circles is for 
    2010 to represent the midpoint of the range of years.<br/>
    3. The size of the circle represents the percent of the national population to keep 
    the circles consistent across plots. <br/> 4. The red lines 
    represent the national average (all rural and urban areas combined). <br/> 5. The blue regression line uses
	the population of the cities as weights, so larger cities have more influence on the line and smaller cities have less.
	<br/> 6. Note that the 
    starting year and ending year differs between plots due to data limitations. 
    <br/> 7. When hovering over the blue regression line,
    the R^2 and p-value of the regression line are shown. The higher the
    R^2 (ranging from 0 to 1), the better line fits the data. The lower the p-value,
    the greater the statistical significance of the observed difference of the regression line 
    from a horizontal line. p < 0.05 is considered significant. 
    <br/> Data File: 
    <a href="https://github.com/WilliamShih9/WilliamShih9.github.io/blob/main/data_GDP.csv" target="_blank">
    https://github.com/WilliamShih9/WilliamShih9.github.io/blob/main/data_GDP.csv</a><br/> 
    Raw Downloaded Data: <a href="https://github.com/WilliamShih9/WilliamShih9.github.io/blob/main/CITIES_26072022091653320.csv"  target="_blank">
    https://github.com/WilliamShih9/WilliamShih9.github.io/blob/main/CITIES_26072022091653320.csv
    </a> 
    <br/> Raw Data Source: 
    <a href="https://stats.oecd.org/Index.aspx?DataSetCode=CITIES#" target="_blank">
    https://stats.oecd.org/Index.aspx?DataSetCode=CITIES#</a></p>

<script>

function get_labels(country, yaxis = "PopulationGrowth"){
    if (yaxis == "PopulationGrowth"){
        switch(country){
            case 'France':
                x = "GDP per capita (2015 dollars)(2006)";
                y = "Population in 2018 (2006 = 100)";
                title = "GDP per capita in 2006 and Population Growth (2006−2018) by Metro Area for France";
                return [x, y, title];
            case 'Japan':
                x = "GDP per capita (2015 dollars)(2001)";
                y = "Population in 2018 (2001 = 100)";
                title = "GDP per capita in 2001 and Population Growth (2001−2018) by Metro Area for Japan";
                return [x, y, title];
            case 'Italy':
                x = "GDP per capita (2015 dollars)(2002)";
                y = "Population in 2018 (2002 = 100)";
                title = "GDP per capita in 2002 and Population Growth (2002−2018) by Metro Area for Italy";
                return [x, y, title];
            case 'Spain':
                x = "GDP per capita (2015 dollars)(2003)";
                y = "Population in 2018 (2003 = 100)";
                title = "GDP per capita in 2003 and Population Growth (2003−2018) by Metro Area for Spain";
                return [x, y, title];
            default:
                x = "GDP per capita (2015 dollars)(2001)";
                y = "Population in 2019 (2001 = 100)";
                title  = "GDP per capita in 2001 and Population Growth (2001−2019) by Metro Area for "+country;
                return [x, y, title];
        }
    }
    else if (yaxis == "GDPGrowth"){
        switch(country){
            case 'France':
                x = "GDP per capita (2015 dollars)(2006)";
                y = "GDP per capita in 2018 (2006 = 100)";
                title = "GDP per capita in 2006 and GDP per capita Growth (2006−2018) by Metro Area for France";
                return [x, y, title];
            case 'Japan':
                x = "GDP per capita (2015 dollars)(2001)";
                y = "GDP per capita in 2016 (2001 = 100)";
                title = "GDP per capita in 2001 and GDP per capita Growth (2001−2016) by Metro Area for Japan";
                return [x, y, title];
            case 'Italy':
                x = "GDP per capita (2015 dollars)(2002)";
                y = "GDP per capita in 2018 (2002 = 100)";
                title = "GDP per capita in 2002 and GDP per capita Growth (2002−2018) by Metro Area for Italy";
                return [x, y, title];
            case 'Spain':
                x = "GDP per capita (2015 dollars)(2003)";
                y = "GDP per capita in 2018 (2003 = 100)";
                title = "GDP per capita in 2003 and GDP per capita Growth (2003−2018) by Metro Area for Spain";
                return [x, y, title];
            case 'Canada':
            case 'Germany':
            case 'Poland':
                x = "GDP per capita (2015 dollars)(2001)";
                y = "GDP per capita in 2018 (2001 = 100)";
                title = "GDP per capita in 2001 and GDP per capita Growth (2001-2018) by Metro Area for "+country;
                return [x, y, title];
            default:
                x = "GDP per capita (2015 dollars)(2001)";
                y = "GDP per capita in 2019 (2001 = 100)";
                title = "GDP per capita in 2001 and GDP per capita Growth (2001-2019) by Metro Area for "+country;
                return [x, y, title];
        }
    }
}

function get_GDPyr(country){
    switch(country){
        case 'France':
            return "2006";
        case 'Spain':
            return "2003";
        case 'Italy':
            return "2002";
        default:
            return "2001";
    }
}

function get_GDPendyr(country){
    switch(country){
        case 'Japan':
            return "2016";
        case 'France':
        case 'Italy':
        case 'Spain':
            return "2018";
        default:
            return "2019";
    }
}


function set_all(unselected){
    d3.select("#scene0").style('background-color', unselected);
    d3.select("#scene1").style('background-color', unselected);
    d3.select("#scene2").style('background-color', unselected);
    d3.select("#scene3").style('background-color', unselected);
    d3.select("#scene4").style('background-color', unselected);
    d3.select("#scene5").style('background-color', unselected);
    d3.select("#scene6").style('background-color', unselected);
}

function country_population(population, yaxis){
    if (yaxis == "PopulationGrowth"){
        return "<br/> Population in 2010: "+ d3.format(',')(population);
    }
    else{
        return "";
    }
}


function get_text(num_scene){
    switch (num_scene){
        case 0:
            return `Housing is a very big issue in many countries as 
                real housing prices have increased dramatically over the past 20
                years as interest rates have fallen. As interest rates fall due
                to slowing economies, the housing prices increase as it is
                easier to borrow money. In most cases, housing prices
                increased because restrictive housing regulations make it
                difficult for supply to meet demand. <br/><br/> However, the restrictions on
                housing are not equal within countries. In some countries, 
                high-density housing is much more restrictive than low-density housing.
                If a city runs out of space to build low-density housing,
                then new housing may be severely limited. Wealthy cities
                are much more likely to meet this limit as these are 
                the cities that people move to, while people don't want
                to move to poorer cities anyways. <br/><br/>
                Click through the slides in order to see illustrate how differences in 
                housing markets between countries result in differences in
                population growth in relatively rich and poor cities in those countries. Keep in 
                mind these plots only show the relative housing 
                shortage, not an absolute housing shortage. If every city in a country somehow has an equally severe housing shortage, it won't be shown through these plots.
            `;
        case 1:
            return `A plot of GDP per capita 
                (roughly equivalent to income per person)
                versus Population Growth tells us whether
                housing production is limited in the richest cities relative to poor cities.
                If housing was not limited, people would move from poor cities to
                rich cities. Therefore, rich cities should grow faster than poor cities.
                The regression line below would be upward sloping in that case.
                <br/><br/>
                Japan is a famous example where this is the case.
                Tokyo is the richest and largest city in Japan while having the fastest
                population growth. Japan is known to have flexible 
                housing laws that allow for housing construction even in population dense areas.
                <br/>
                If interested in specific details, 
                hover over any line (red/blue) or circle to see more information. Note that the area of each circle indicates the population of the metro area.
            `;
        case 2:
            return `A plot of GDP per capita versus GDP per capita growth 
                tells us if the income per person is converging or diverging between cities. If cities
                with higher initial GDP per capita had lower GDP per capita growth, the income per
                preson would be converging and the regression line would be downward sloping.
                This is related to housing since with unlimited mobility, income per person
                would converge as people would move from poorer to richer cities. 
                <br/><br/>
                This is roughly the case in Japan although the significance of the regression
                line is not impressive. Tokyo's GDP per capita growth was slightly lower
                than the national average. At least the line is not upward sloping (which would 
                imply the rich getting relatively richer and poor getting relatively poorer)
                as it is in some other countries as you will see later on.
            `;
        case 3:
            return `In contrast to Japan, the United States is a good example
                where housing is severely limited in cities that have run out of space
                to build low-density housing. New York City is one of the richest cities
                and is the largest city in the US but had one of the lowest population growth
                of any city. Similarly, San Francisco was the richest city in 2001 and 
                its population grew slower than the national average.
                <br/><br/>
                While many rich cities already ran out of space for
                low-density housing by the early 2000s, there are three notable cities: 
                Houston, Dallas, and Atlanta. These 3 cities were wealthy in 2001 
                and did not run out of space for low-density housing yet. Unlike
                San Francisco (peninsula)
                and New York (island/peninsula), they are not constrained by geography.
                It is still possible they may run out of space soon 
                and population will cease to grow.
             `;
        case 4:
            return `The GDP per capita versus GDP per capita growth plot shows that cities
                in the United States are diverging in income per person. Richer cities are becoming
                even wealthier relative to the average, while other cities are falling behind.
                One possible reason this may occur is housing is constrained in 
                rich cities so that only relatively wealthy people move to those rich cities 
                because housing prices are so high. Meanwhile, relatively poor people move to 
                cities where housing prices are low. Also, many housing constrained cities have high rates of highly educated immigrants. <br/><br/> 
                Housing contrained San Francisco, New York City, and Boston grew faster
                than the national average in income per person. 
                The cities that were relatively rich in 2001 from the
                previous plot that grew rapidly in population 
                (Houston, Dallas, and Atlanta) grew slower than average in income per person.
            `;
        case 5:
            return `France is an example of a country which is dominated heavily
                by a single city: Paris. Paris is much larger and wealthier than
                any other city in France. However, the chart shows that the population
                of Paris did not even grow faster than the national average, in constrast to Tokyo, 
                Japan. This is despite that Paris is 50% richer than national average, compared to 
                20% richer for Tokyo. 
                <br/><br/>
                The fastest growing cities in France such as Rennes, Bordeaux, and Nantes are 
                much poorer than Paris. This implies that housing is constrained in Paris,
                as the population should have grown much faster considering how rich Paris
                is relative to the national average.
            `;
        case 6:
            return `The GDP per capita versus GDP per capita growth plot shows that Paris
                is actually growing faster in wealth than any other city in France 
                (again in contrast with Japan).  Similar to the United States, if housing was not constrained, productivity
                would not have increased as much as people moving there would be poorer 
                and less productive on average since housing prices would also be lower.
                <br/><br/>
                That concludes the slideshow as showing two plots of all 
                10 countries will be long-winded and redundant.
                For more, plots for Australia, Canada, Germany, Italy, Poland, Spain, and the United Kingdom 
                (and also the countries you've seen already)
                are accessible through the dropdown menu below. You can choose whether to 
                see GDP per capita growth or Population growth on the Y-Axis through
                the second dropdown menu. 
            `;
        default:
            return "This is Scene Undefined";
    }
}

function get_annotations(country, yaxis){
    if (yaxis == "PopulationGrowth"){
        switch(country){
            case 'Japan':
                return [
                  {
                    note: {
                      label: "Tokyo is the richest city in Japan and had the fastest population growth"
                    },
                    type: d3.annotationCalloutCircle,
                    subject: {
                      radius: 60,        
                    },
                    color: ["green"],
                    x: 683,
                    y: 160,
                    dy: -20,
                    dx: -60
                  },
                  {
                    note: {
                      label: "Nagoya is relatively rich and has relatively fast population growth"
                    },
                    type: d3.annotationCalloutCircle,
                    subject: {
                      radius: 40,        
                    },
                    color: ["green"],
                    x: 543,
                    y: 230,
                    dy: 70,
                    dx: 60
                  }
                ];
            case 'United States':
                return [
                  {
                    note: {
                      label: "San Francisco is the richest city and had below average population growth"
                    },
                    type: d3.annotationCalloutCircle,
                    subject: {
                      radius: 20,        
                    },
                    color: ["green"],
                    x: 608,
                    y: 437,
                    dy: 60,
                    dx: 18
                  },
                  {
                    note: {
                      label: "New York City is the biggest city and is rich but has very low population growth"
                    },
                    type: d3.annotationCalloutCircle,
                    subject: {
                      radius: 25,        
                    },
                    color: ["green"],
                    x: 477,
                    y: 480,
                    dy: 25,
                    dx: 0
                  },
                  {
                    note: {
                      label: "Houston"
                    },
                    type: d3.annotationCalloutCircle,
                    subject: {
                      radius: 16,        
                    },
                    color: ["green"],
                    x: 396,
                    y: 268,
                    dy: -125,
                    dx: 0
                  },
                  {
                    note: {
                      label: "Dallas"
                    },
                    type: d3.annotationCalloutCircle,
                    subject: {
                      radius: 16,        
                    },
                    color: ["green"],
                    x: 377,
                    y: 297,
                    dy: -10,
                    dx: 110
                  },
                  {
                    note: {
                      label: "Atlanta"
                    },
                    type: d3.annotationCalloutCircle,
                    subject: {
                      radius: 16,        
                    },
                    color: ["green"],
                    x: 457,
                    y: 307,
                    dy: 5,
                    dx: 44
                  }
                ];
            case 'France':
                return [
                  {
                    note: {
                      label: "Paris is by far the richest city in Japan and had only average population growth"
                    },
                    type: d3.annotationCalloutCircle,
                    subject: {
                      radius: 40,        
                    },
                    color: ["green"],
                    x: 697,
                    y: 313,
                    dy: 110,
                    dx: -50
                  },
                  {
                    note: {
                      label: "Rennes, Bordeaux, and Nantes"
                    },
                    type: d3.annotationCalloutCircle,
                    subject: {
                      radius: 35,        
                    },
                    color: ["green"],
                    x: 395,
                    y: 164,
                    dy: -30,
                    dx: 19
                  }
                ]; 
            default:
                return [];
        }
    }
    else if (yaxis = "GDPGrowth"){
        switch(country){
            case 'Japan':
                return [
                  {
                    note: {
                      label: "Tokyo is the richest city in Japan and had slower than average income growth"
                    },
                    type: d3.annotationCalloutCircle,
                    subject: {
                      radius: 60,        
                    },
                    color: ["green"],
                    x: 690,
                    y: 387,
                    dy: -180,
                    dx: -100
                  }
                ];            
            case 'United States':
                return [
                  {
                    note: {
                      label: "San Francisco was the richest city in 2001 and still grew GDP per capita the most of any city"
                    },
                    type: d3.annotationCalloutCircle,
                    subject: {
                      radius: 25,        
                    },
                    color: ["green"],
                    x: 610,
                    y: 97,
                    dy: 30,
                    dx: 0
                  },
                  {
                    note: {
                      label: "Dallas"
                    },
                    type: d3.annotationCalloutCircle,
                    subject: {
                      radius: 15,        
                    },
                    color: ["green"],
                    x: 377,
                    y: 361,
                    dy: 66,
                    dx: 5
                  },
                  {
                    note: {
                      label: "Houston"
                    },
                    type: d3.annotationCalloutCircle,
                    subject: {
                      radius: 15,        
                    },
                    color: ["green"],
                    x: 395,
                    y: 377,
                    dy: 15,
                    dx: 0
                  },
                  {
                    note: {
                      label: "Atlanta"
                    },
                    type: d3.annotationCalloutCircle,
                    subject: {
                      radius: 15,        
                    },
                    color: ["green"],
                    x: 463,
                    y: 424,
                    dy: 30,
                    dx: 0
                  },
                  {
                    note: {
                      label: "New York City"
                    },
                    type: d3.annotationCalloutCircle,
                    subject: {
                      radius: 25,        
                    },
                    color: ["green"],
                    x: 480,
                    y: 264,
                    dy: -30,
                    dx: -30
                  },
                  {
                    note: {
                      label: "Boston"
                    },
                    type: d3.annotationCalloutCircle,
                    subject: {
                      radius: 15,        
                    },
                    color: ["green"],
                    x: 530,
                    y: 267,
                    dy: 30,
                    dx: 30
                  }
                ];    
            case 'France':
                return [
                  {
                    note: {
                      label: "Paris is the richest city in France by far and yet also had far the fastest GDP per capita growth"
                    },
                    type: d3.annotationCalloutCircle,
                    subject: {
                      radius: 40,        
                    },
                    color: ["green"],
                    x: 696,
                    y: 165,
                    dy: -10,
                    dx: -50
                  },
                  {
                    note: {
                      label: "Many of the poorest cities in France reduced their GDP per capita from 2006 to 2018"
                    },
                    type: d3.annotationCalloutCircle,
                    subject: {
                      radius: 70,        
                    },
                    color: ["green"],
                    x: 262,
                    y: 466,
                    dy: 20,
                    dx: -65
                  }
                ]; 
            default:
                return [];
        }
    }
}

async function init(){
    var margin = 50;
    var width = 650;
    var height = 550;
    var tooltip = d3.select("body").append("div")
        .attr("class", "tooltip")
        .style("opacity", 0);
    
    var tooltip2 = d3.select("body").append("div")
        .attr("class", "tooltip2")
        .style("opacity", 0);
        
    var tooltip_reg = d3.select("body").append("div")
        .attr("class", "tooltip_reg")
        .style("opacity", 0);
        
    var unselected = "#04AA6D";
    var selected = "#99ccee";
    var cur_scene = 0;
    
    // Country Select Button
    countries = ['Australia','Canada','France','Germany','Italy','Japan','Poland',
                'Spain','United Kingdom','United States'];
    d3.select("#selectButton")
        .selectAll('myOptions')
        .data(countries)
        .enter()
        .append('option')
        .text(function (d) { return d; }) // text showed in the menu
        .attr("value", function (d) { return d; });
    // Y Axis GDP per capita Button or Population growth button
    yaxis = ['Population Growth on Y-Axis','GDP Growth on Y-Axis']
    d3.select("#yaxisButton")
        .selectAll('myOptions')
        .data(yaxis)
        .enter()
        .append('option')
        .text(function (d) { return d; }) // text showed in the menu
        .attr("value", function (d) { return d; });
    
    // Data
    var data = await d3.csv("https://raw.githubusercontent.com/WilliamShih9/WilliamShih9.github.io/main/data_GDP.csv", d3.autoType);
    var aggregate = await d3.csv("https://raw.githubusercontent.com/WilliamShih9/WilliamShih9.github.io/main/aggregates_GDP.csv", d3.autoType);
    
    async function draw_chart(data, aggregate, country = "Japan", yaxis = "PopulationGrowth"){
        d3.select("svg").selectAll('*').remove();
        let lines;
        if (yaxis == "PopulationGrowth"){
            lines = await d3.csv("https://raw.githubusercontent.com/WilliamShih9/WilliamShih9.github.io/main/regression_lines.csv", d3.autoType);
        }
        else if (yaxis == "GDPGrowth"){
            lines = await d3.csv("https://raw.githubusercontent.com/WilliamShih9/WilliamShih9.github.io/main/regression_lines_GDP.csv", d3.autoType);
        }
        
        // Set Text
        d3.select("#maintext").html(get_text(cur_scene));
        
        if (cur_scene == 0){
            return;
        }
        // Agg Data is for the Vertical/Horizontal Line
        agg_data = aggregate.filter(function(row) {
            return row['Country'] == country;
        });
        
        // Line Data is for the Regression Line
        line_data = lines.filter(function(row) {
            return row['Country'] == country;
        });
        filt_data = data.filter(function(row) {
            return row['Country'] == country;
        });
        
        var x_min = d3.min(filt_data, function(d) { return d.GDP; });
        var x_max = d3.max(filt_data, function(d) { return d.GDP; });
        var y_min = d3.min(filt_data, function(d) { return d[yaxis]; }) - 5;
        var y_max = d3.max(filt_data, function(d) { return d[yaxis]; }) + 5;
        
        
        var x = d3.scaleLinear().domain([x_min, x_max]).range([0, width]).nice();
        var y = d3.scaleLinear().domain([y_min, y_max]).range([height, 0]).nice();
        var sqrtScale = d3.scaleSqrt().domain([0, 100]).range([0, 70]);
        
        d3.select("svg")
            .attr("width", width + 2*margin)
            .attr("height", height + 2*margin);
    
        // X Gridlines
        d3.select("svg").append("g")
            .attr("class", "grid")
            .attr("transform","translate("+margin+","+(height+margin)+")")
            .call(d3.axisBottom(x).tickSize(-height).tickFormat('').ticks(10));
          
        // Y Gridlines
        d3.select("svg").append("g")
            .attr("class", "grid")
            .attr("transform","translate("+margin+","+margin+")")
            .call(d3.axisLeft(y).tickSize(-width).tickFormat('').ticks(10));
            
        // X Axis
        d3.select("svg").append("g")
            .style("font-size","11px")
            .attr("transform","translate("+margin+","+(height+margin)+")")
            .call(d3.axisBottom(x).ticks(10));
        
        // Y Axis
        d3.select("svg").append("g")
            .style("font-size","12px")
            .attr("transform","translate("+margin+","+margin+")")
            .call(d3.axisLeft(y).ticks(10));
         
        // Get Labels for X-Axis, Y-Axis, Title for Country
        result = get_labels(country, yaxis);
        x_axis_label = result[0];
        y_axis_label = result[1];
        title = result[2];
        // Text Label X Axis
        d3.select("svg").append("text")             
          .attr("transform",
                "translate(" + ((width+margin)/2) + " ," + 
                               (height + 2*margin - 10) + ")")
          .style("font-size","17px")
          .style("text-anchor", "middle")
          .text(x_axis_label);   
         
        // text label for the y axis
        d3.select("svg").append("text")
          .attr("transform", "rotate(-90)")
          .attr("y", 0)
          .attr("x" ,0 - ((height + margin) / 2))
          .attr("dy", "1em")
          .style("font-size","17px")
          .style("text-anchor", "middle")
          .text(y_axis_label);  
        
        // Title
        d3.select("svg").append("text")
            .attr("transform", "translate("+margin+","+margin+")")
            .attr("x", (width / 2))             
            .attr("y", 0 - (margin / 2))
            .attr("text-anchor", "middle")  
            .style("font-size", "17px") 
            .style("text-decoration", "underline")  
            .text(title);
    
        h_line = agg_data[0][yaxis];
        
        // Add Annotations
        const annotations = get_annotations(country, yaxis);
        if (annotations.length > 0){
            const makeAnnotations = d3.annotation()
              .annotations(annotations);
            d3.select("svg")
                .append("g")
                .call(makeAnnotations);
        }
        // Horizontal Line
        d3.select("svg").append("g")
           .attr("class","hline")
           .attr("transform", "translate("+margin+", "+(margin+y(h_line))+")")
           .append("line")
           .attr("x2", width)
           .style("stroke", "#cc3e2e")
           .style("stroke-width", "4px")
        
        v_line = agg_data[0]["GDP"];
        mult_v = agg_data[0]["GDPGrowth"];
        // Vertical Line
        d3.select("svg").append("g")
           .attr("class", "vline")
           .attr("transform", "translate("+(margin+x(v_line))+","+margin+")")
           .append("line")
           .attr("y2", height)
           .style("stroke", "#cc3e2e")
           .style("stroke-width", "4px")
           
        slope = line_data[0]["Slope"]
        intercept = line_data[0]["Intercept"]
        y_reg_low = x_min * slope + intercept;
        y_reg_high = x_max * slope + intercept;
        // Regression Line
        d3.select("svg").append("g")
            .attr("class","regline")
            .attr("transform","translate("+margin+","+margin+")")
            .append("line")
            .attr("x1", x(x_min))
            .attr("x2", x(x_max))
            .attr("y1", y(y_reg_low))
            .attr("y2", y(y_reg_high))
            .style("stroke", "#2e31cc")
            .style("stroke-width", "4px")
        
        // Data
        d3.select("svg").append("g")
            .attr("transform", "translate(" +margin+ "," +margin+ ")")
            .selectAll("dot")
            .data(filt_data)
            .enter().append("circle")
            .attr("cx", function (d) { return x(d.GDP); })
            .attr("cy", function (d) { return y(d[yaxis]); })
            .attr("r",  function (d) { return sqrtScale(d.Percent); })
        
        
        // Tooltip for Circles
        d3.select("svg").selectAll("circle").data(filt_data)
            .on("mouseover", function(event, d) {		
                tooltip.transition()		
                    .duration(200)		
                    .style("opacity", .9);		
                tooltip.html(d.Metro + "<br/>"  + "Pop(2010):"+d3.format(',')(d.Population)
                            + "<br/>GDP(" + get_GDPyr(country) + "):" + d3.format(',')(d.GDP)
                            + "<br/>GDP(" + get_GDPendyr(country) + "):" + d3.format(',')(d.GDPGrowth/100*d.GDP))
                    .style("left", (event.pageX) + "px")		
                    .style("top", (event.pageY - 28) + "px");	
            })	
            .on("mousemove", function(event){
                tooltip
                    .style("left", (event.pageX) + "px")
                    .style("top", (event.pageY- 28) + "px");
            })
            .on("mouseout", function(event) {		
                tooltip.transition()		
                    .duration(500)		
                    .style("opacity", 0);	
            });
        
        // Tooltip for Horizontal  Line
        d3.select("svg").select(".hline")
            .on("mouseover", function(event, d) {		
                tooltip2.transition()		
                    .duration(200)		
                    .style("opacity", .9);		
                tooltip2.html(country+"<br/>"+ y_axis_label + ": " + d3.format(".2f")(h_line) 
                            + country_population(agg_data[0]["Population"], yaxis))
                    .style("left", (event.pageX) + "px")		
                    .style("top", (event.pageY + 18) + "px");	
            })	
            .on("mousemove", function(event){
                tooltip2
                    .style("left", (event.pageX) + "px")
                    .style("top", (event.pageY + 18) + "px");
            })
            .on("mouseout", function(event) {		
                tooltip2.transition()		
                    .duration(500)		
                    .style("opacity", 0);	
            });
        // Tooltip for Vertical Line
        d3.select("svg").select(".vline")
            .on("mouseover", function(event, d) {		
                tooltip2.transition()		
                    .duration(200)		
                    .style("opacity", .9);		
                tooltip2.html(country+"<br/>"+ x_axis_label + ": " + d3.format(',')(v_line)
                            + "<br/>GDP per capita (" + get_GDPendyr(country) + "): " 
                            + d3.format(',')(v_line*mult_v/100))
                    .style("left", (event.pageX) + "px")		
                    .style("top", (event.pageY + 18) + "px");	
            })	
            .on("mousemove", function(event){
                tooltip2
                    .style("left", (event.pageX) + "px")
                    .style("top", (event.pageY + 18) + "px");
            })
            .on("mouseout", function(event) {		
                tooltip2.transition()		
                    .duration(500)		
                    .style("opacity", 0);	
            });
        // Tooltip for Regression Line
        d3.select("svg").select(".regline")
            .on("mouseover", function(event, d) {		
                tooltip_reg.transition()		
                    .duration(200)		
                    .style("opacity", .9);		
                tooltip_reg.html("Regression Line <br/>R^2 of line: "+
                    d3.format('.3f')(line_data[0]["R2"]) + "<br/>p = " +
                    d3.format('.3')(line_data[0]["Pval"]))
                    .style("left", (event.pageX) + "px")		
                    .style("top", (event.pageY + 18) + "px");	
            })	
            .on("mousemove", function(event){
                tooltip_reg
                    .style("left", (event.pageX) + "px")
                    .style("top", (event.pageY + 18) + "px");
            })
            .on("mouseout", function(event) {		
                tooltip_reg.transition()		
                    .duration(100)		
                    .style("opacity", 0);	
            });
    }
    draw_chart(data, aggregate, "Japan", "PopulationGrowth");
    d3.select("#scene0").style('background-color', selected);
    
    d3.select("#scene0").on("click", function() {  
        cur_scene = 0;
        set_all(unselected);
        d3.select(this).style('background-color', selected);
        document.getElementById("bottomtext").setAttribute("hidden","hidden"); 
        document.getElementById("hiddenhr").setAttribute("hidden","hidden"); 
        document.getElementById("selectButton").setAttribute("hidden","hidden");
        document.getElementById("yaxisButton").setAttribute("hidden","hidden"); 
        document.getElementById("selectButton").setAttribute("disabled","true");
        document.getElementById("yaxisButton").setAttribute("disabled","true"); 
        draw_chart(data, aggregate, "Japan", "PopulationGrowth");
    });
    
    d3.select("#scene1").on("click", function() {  
		document.getElementById("selectButton").setAttribute("disabled","true");
        document.getElementById("yaxisButton").setAttribute("disabled","true"); 
        document.getElementById("bottomtext").removeAttribute("hidden"); 
        cur_scene = 1;
        set_all(unselected);
        d3.select(this).style('background-color', selected);
        d3.select("#selectButton").property('value', "Japan");
        d3.select("#yaxisButton").property('value','Population Growth on Y-Axis');
        draw_chart(data, aggregate, "Japan", "PopulationGrowth");
    });
    d3.select("#scene2").on("click", function() {  
		document.getElementById("selectButton").setAttribute("disabled","true");
        document.getElementById("yaxisButton").setAttribute("disabled","true"); 
        document.getElementById("bottomtext").removeAttribute("hidden"); 
        cur_scene = 2;
        set_all(unselected);
        d3.select(this).style('background-color', selected);
        d3.select("#selectButton").property('value', "Japan");
        d3.select("#yaxisButton").property('value','GDP Growth on Y-Axis');
        draw_chart(data, aggregate, "Japan", "GDPGrowth");
    });
    d3.select("#scene3").on("click", function() {  
		document.getElementById("selectButton").setAttribute("disabled","true");
        document.getElementById("yaxisButton").setAttribute("disabled","true"); 
        document.getElementById("bottomtext").removeAttribute("hidden"); 
        cur_scene = 3;
        set_all(unselected);
        d3.select(this).style('background-color', selected);
        d3.select("#selectButton").property('value', "United States");
        d3.select("#yaxisButton").property('value','Population Growth on Y-Axis');
        draw_chart(data, aggregate, "United States", "PopulationGrowth");
    });
    d3.select("#scene4").on("click", function() {
		document.getElementById("selectButton").setAttribute("disabled","true");
        document.getElementById("yaxisButton").setAttribute("disabled","true"); 
        document.getElementById("bottomtext").removeAttribute("hidden"); 
        cur_scene = 4;
        set_all(unselected);
        d3.select(this).style('background-color', selected);
        d3.select("#selectButton").property('value', "United States");
        d3.select("#yaxisButton").property('value','GDP Growth on Y-Axis');
        draw_chart(data, aggregate, "United States", "GDPGrowth");
    });
    d3.select("#scene5").on("click", function() {  
		document.getElementById("selectButton").setAttribute("disabled","true");
        document.getElementById("yaxisButton").setAttribute("disabled","true"); 
        document.getElementById("bottomtext").removeAttribute("hidden"); 
        cur_scene = 5;
        set_all(unselected);
        d3.select(this).style('background-color', selected);
        d3.select("#selectButton").property('value', "France");
        d3.select("#yaxisButton").property('value','Population Growth on Y-Axis');
        draw_chart(data, aggregate, "France", "PopulationGrowth");
    });
    d3.select("#scene6").on("click", function() {  
        cur_scene = 6;
        set_all(unselected);
        d3.select(this).style('background-color', selected);
        d3.select("#selectButton").property('value', "France");
        d3.select("#yaxisButton").property('value','GDP Growth on Y-Axis');
        draw_chart(data, aggregate, "France", "GDPGrowth");
        // Unhide Buttons
        document.getElementById("bottomtext").removeAttribute("hidden"); 
        document.getElementById("hiddenhr").removeAttribute("hidden"); 
		document.getElementById("selectButton").removeAttribute("hidden"); 
        document.getElementById("yaxisButton").removeAttribute("hidden"); 
        document.getElementById("selectButton").disabled = false;
        document.getElementById("yaxisButton").disabled = false; 
        
        d3.select("#selectButton")
            .on("change", function (event){
                yaxis_val = d3.select("#yaxisButton").node().value;
                country_val = d3.select("#selectButton").node().value;
                if (yaxis_val == "GDP Growth on Y-Axis"){
                    draw_chart(data, aggregate, country_val, "GDPGrowth");
                }
                else if (yaxis_val == "Population Growth on Y-Axis"){
                    draw_chart(data, aggregate, country_val, "PopulationGrowth");
                }
            });
        d3.select("#yaxisButton")
            .on("change", function (event){
                yaxis_val = d3.select("#yaxisButton").node().value;
                country_val = d3.select("#selectButton").node().value;
                if (yaxis_val == "GDP Growth on Y-Axis"){
                    draw_chart(data, aggregate, country_val, "GDPGrowth");
                }
                else if (yaxis_val == "Population Growth on Y-Axis"){
                    draw_chart(data, aggregate, country_val, "PopulationGrowth");
                }
            });
    });
    
}

</script>
</body>
</html>

<!DOCTYPE html>
<meta charset="utf-8">

